{% extends 'quiz_app/base.html' %}

{% block title %}AI Chat Assistant{% endblock %}

{% block content %}
<div class="container-fluid py-4 px-3" style="height: 90vh; display: flex; flex-direction: column; background: linear-gradient(to right, #141e30, #243b55); color: #f8f9fa;">
    <!-- Chat Header -->
    <div class="bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 text-white rounded-2xl p-4 shadow mb-3 d-flex justify-content-between align-items-center" style="background: linear-gradient(90deg, #667eea, #764ba2);">
        <h4 class="mb-0 fw-bold text-white px-4 py-2 rounded-3" style="background: linear-gradient(90deg, #4b6cb7, #182848); box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <i class="fas fa-brain me-2 text-warning"></i> {{ session.title }}
        </h4>
        <div class="d-flex gap-2">
            <a href="{% url 'chat_sessions' %}" class="btn btn-light btn-sm">
                <i class="fas fa-arrow-left me-1"></i>Back
            </a>
            <a href="{% url 'delete_chat_session' session.id %}" class="btn btn-danger btn-sm"
               onclick="return confirm('Are you sure you want to delete this chat session?')">
                <i class="fas fa-trash-alt me-1"></i>Delete
            </a>
        </div>
    </div>


    <!-- Chat Messages -->
    <div class="flex-grow-1 overflow-auto px-2" id="chat-messages" style="background: #f7f7f7; border-radius: 1rem; padding: 1rem;">
        {% for message in messages %}
            <div class="d-flex {% if message.is_user_message %}justify-content-end{% else %}justify-content-start{% endif %} mb-3">
                <div class="card shadow-sm {% if message.is_user_message %}bg-primary text-white{% else %}bg-light{% endif %}" style="max-width: 70%; border-radius: 1.25rem;">
                    <div class="card-body p-3">
                        <p class="small mb-1">
                            <strong>
                                {% if message.is_user_message %}
                                    <i class="fas fa-user me-1"></i>You
                                {% else %}
                                    <i class="fas fa-robot me-1"></i>AI Teacher
                                {% endif %}
                            </strong>
                        </p>
                        <div class="message-content">
                            {{ message.content|linebreaksbr }}
                        </div>
                        <p class="text-muted small mt-2 mb-0">
                            {{ message.timestamp|date:"d M Y - H:i" }}
                        </p>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Message Input Form -->
    <div class="mt-3">
        <form method="post" id="chat-form">
            {% csrf_token %}
            <div class="input-group shadow">
                {{ form.content }}
                <button type="submit" class="btn btn-gradient btn-primary">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<style>
#chat-messages {
    scrollbar-width: thin;
    scrollbar-color: #888 #e0e0e0;
}
#chat-messages::-webkit-scrollbar {
    width: 8px;
}
#chat-messages::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}
#chat-messages::-webkit-scrollbar-track {
    background: #e0e0e0;
    border-radius: 4px;
}
.message-content p {
    margin: 0;
}
.btn-gradient {
    background: linear-gradient(to right, #667eea, #764ba2);
    border: none;
    color: white;
}
.btn-gradient:hover {
    background: linear-gradient(to right, #5a67d8, #6b46c1);
}
textarea.form-control {
    resize: none;
    border-radius: 1rem 0 0 1rem;
    border-right: 0;
}
button.btn.btn-primary {
    border-radius: 0 1rem 1rem 0;
}
</style>

<script>
function scrollToBottom() {
    const chatContainer = document.getElementById('chat-messages');
    if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
}

document.addEventListener('DOMContentLoaded', scrollToBottom);
document.getElementById('chat-form').addEventListener('submit', function() {
    setTimeout(scrollToBottom, 100);
});
</script>
{% endblock %}
